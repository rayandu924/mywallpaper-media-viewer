<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Media Viewer</title>
  <link rel="stylesheet" href="styles.css">
</head>
<body>
  <div id="container">
    <div id="media-wrapper">
      <!-- Dynamic media element will be inserted here -->
    </div>
    <div id="fallback" class="hidden">
      <div class="fallback-icon">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
          <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
          <circle cx="8.5" cy="8.5" r="1.5"/>
          <polyline points="21,15 16,10 5,21"/>
        </svg>
      </div>
      <p id="fallback-text">Media unavailable</p>
    </div>
    <div id="loading" class="hidden">
      <div class="spinner"></div>
    </div>
  </div>

  <script>
    // ==========================================================================
    // Media Viewer Addon - MyWallpaper SDK v2.3
    // ==========================================================================
    // Supports: Images (jpg, png, gif, webp, svg, ico, bmp, avif)
    //           Videos (mp4, webm, ogg, mov)
    //           External URLs and uploaded files
    // ==========================================================================

    (function() {
      'use strict';

      const api = window.MyWallpaper;

      // DOM Elements
      const container = document.getElementById('container');
      const mediaWrapper = document.getElementById('media-wrapper');
      const fallbackEl = document.getElementById('fallback');
      const fallbackText = document.getElementById('fallback-text');
      const loadingEl = document.getElementById('loading');

      // State
      let currentMediaEl = null;
      let refreshTimer = null;
      let isPaused = false;

      // Media type detection
      const VIDEO_EXTENSIONS = ['mp4', 'webm', 'ogg', 'mov', 'm4v', 'avi', 'mkv'];
      const IMAGE_EXTENSIONS = ['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'ico', 'bmp', 'avif', 'tiff'];

      // Embed platforms configuration
      const EMBED_PLATFORMS = {
        youtube: {
          patterns: [
            /youtube\.com\/watch\?v=([^&]+)/,
            /youtube\.com\/embed\/([^?]+)/,
            /youtu\.be\/([^?]+)/,
            /youtube\.com\/shorts\/([^?]+)/
          ],
          embedUrl: (id, opts) =>
            `https://www.youtube-nocookie.com/embed/${id}?autoplay=${opts.autoplay ? 1 : 0}&mute=${opts.muted ? 1 : 0}&loop=${opts.loop ? 1 : 0}&rel=0&modestbranding=1`
        },
        vimeo: {
          patterns: [/vimeo\.com\/(\d+)/],
          embedUrl: (id, opts) =>
            `https://player.vimeo.com/video/${id}?autoplay=${opts.autoplay ? 1 : 0}&muted=${opts.muted ? 1 : 0}&loop=${opts.loop ? 1 : 0}&background=1`
        },
        twitch: {
          patterns: [
            /twitch\.tv\/videos\/(\d+)/,
            /twitch\.tv\/([^/?]+)$/
          ],
          embedUrl: (id, opts, isVideo) => {
            const parent = location.hostname || 'localhost';
            return isVideo
              ? `https://player.twitch.tv/?video=${id}&parent=${parent}&autoplay=${opts.autoplay}`
              : `https://player.twitch.tv/?channel=${id}&parent=${parent}&autoplay=${opts.autoplay}&muted=${opts.muted}`;
          }
        },
        dailymotion: {
          patterns: [/dailymotion\.com\/video\/([^_?]+)/],
          embedUrl: (id, opts) =>
            `https://www.dailymotion.com/embed/video/${id}?autoplay=${opts.autoplay ? 1 : 0}&mute=${opts.muted ? 1 : 0}`
        }
      };

      // ==========================================================================
      // UTILITY FUNCTIONS
      // ==========================================================================

      function getMediaType(url) {
        if (!url) return null;

        // Check for data URLs
        if (url.startsWith('data:')) {
          if (url.startsWith('data:video/')) return 'video';
          if (url.startsWith('data:image/')) return 'image';
          return null;
        }

        // Check for blob URLs
        if (url.startsWith('blob:')) {
          // Can't determine from URL, will try video first then image
          return 'unknown';
        }

        // Extract extension from URL
        try {
          const urlObj = new URL(url);
          const pathname = urlObj.pathname.toLowerCase();
          const extension = pathname.split('.').pop();

          if (VIDEO_EXTENSIONS.includes(extension)) return 'video';
          if (IMAGE_EXTENSIONS.includes(extension)) return 'image';
        } catch (e) {
          // Invalid URL, try extension from string
          const extension = url.split('.').pop()?.toLowerCase().split('?')[0];
          if (VIDEO_EXTENSIONS.includes(extension)) return 'video';
          if (IMAGE_EXTENSIONS.includes(extension)) return 'image';
        }

        // Check common video hosting patterns
        if (url.includes('youtube.com') || url.includes('youtu.be') ||
            url.includes('vimeo.com') || url.includes('dailymotion.com')) {
          // Note: Direct embedding would require iframe, not supported in sandbox
          return null;
        }

        return 'unknown';
      }

      function buildFilterString(settings) {
        const filters = [];

        if (settings.blur > 0) {
          filters.push(`blur(${settings.blur}px)`);
        }
        if (settings.brightness !== 100) {
          filters.push(`brightness(${settings.brightness}%)`);
        }
        if (settings.contrast !== 100) {
          filters.push(`contrast(${settings.contrast}%)`);
        }
        if (settings.saturate !== 100) {
          filters.push(`saturate(${settings.saturate}%)`);
        }
        if (settings.hueRotate > 0) {
          filters.push(`hue-rotate(${settings.hueRotate}deg)`);
        }

        return filters.length > 0 ? filters.join(' ') : 'none';
      }

      function parseEmbedUrl(url, settings) {
        if (!url) return null;

        const opts = {
          autoplay: settings.autoplay ?? true,
          muted: settings.muted ?? true,
          loop: settings.loop ?? false
        };

        for (const [platform, config] of Object.entries(EMBED_PLATFORMS)) {
          for (let i = 0; i < config.patterns.length; i++) {
            const pattern = config.patterns[i];
            const match = url.match(pattern);
            if (match) {
              const id = match[1];
              // For Twitch, check if it's a video or channel
              const isVideo = platform === 'twitch' && url.includes('/videos/');
              return {
                platform,
                embedUrl: config.embedUrl(id, opts, isVideo),
                videoId: id
              };
            }
          }
        }

        return null; // Platform not recognized
      }

      function showLoading() {
        loadingEl.classList.remove('hidden');
        fallbackEl.classList.add('hidden');
      }

      function hideLoading() {
        loadingEl.classList.add('hidden');
      }

      function showFallback(message) {
        hideLoading();
        fallbackText.textContent = message || api.config.fallbackText || 'Media unavailable';
        fallbackEl.classList.remove('hidden');
        if (currentMediaEl) {
          currentMediaEl.classList.add('hidden');
        }
      }

      function hideFallback() {
        fallbackEl.classList.add('hidden');
      }

      // ==========================================================================
      // MEDIA CREATION
      // ==========================================================================

      function createImageElement(url, settings) {
        const img = document.createElement('img');
        img.className = 'media-element';
        img.alt = 'Media content';
        img.draggable = false;

        img.onload = () => {
          hideLoading();
          hideFallback();
          img.classList.remove('hidden');
          api.renderComplete();
        };

        img.onerror = () => {
          console.error('[MediaViewer] Failed to load image:', url);
          showFallback(settings.fallbackText);
        };

        img.src = url;
        return img;
      }

      function createVideoElement(url, settings) {
        const video = document.createElement('video');
        video.className = 'media-element';

        // Video attributes
        video.autoplay = settings.autoplay && !isPaused;
        video.loop = settings.loop;
        video.muted = settings.muted;
        video.controls = settings.showControls;
        video.playbackRate = settings.playbackRate;
        video.playsInline = true;
        video.preload = 'auto';

        video.onloadeddata = () => {
          hideLoading();
          hideFallback();
          video.classList.remove('hidden');
          api.renderComplete();
        };

        video.onerror = (e) => {
          console.error('[MediaViewer] Failed to load video:', url, e);
          showFallback(settings.fallbackText);
        };

        // Handle autoplay failures (browser restrictions)
        video.onplay = () => {
          console.log('[MediaViewer] Video playing');
        };

        const source = document.createElement('source');
        source.src = url;

        // Try to determine MIME type
        const ext = url.split('.').pop()?.toLowerCase().split('?')[0];
        const mimeTypes = {
          mp4: 'video/mp4',
          webm: 'video/webm',
          ogg: 'video/ogg',
          mov: 'video/quicktime',
          m4v: 'video/mp4'
        };
        if (mimeTypes[ext]) {
          source.type = mimeTypes[ext];
        }

        video.appendChild(source);
        return video;
      }

      function createEmbedElement(embedData, settings) {
        const iframe = document.createElement('iframe');
        iframe.className = 'media-element embed-frame';
        iframe.src = embedData.embedUrl;
        iframe.frameBorder = '0';
        iframe.allow = 'accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share';
        iframe.allowFullscreen = true;
        iframe.setAttribute('referrerpolicy', 'no-referrer-when-downgrade');

        iframe.onload = () => {
          hideLoading();
          hideFallback();
          iframe.classList.remove('hidden');
          api.renderComplete();
          console.log(`[MediaViewer] ${embedData.platform} embed loaded`);
        };

        iframe.onerror = () => {
          console.error(`[MediaViewer] Failed to load ${embedData.platform} embed`);
          showFallback(`Failed to load ${embedData.platform} video`);
        };

        return iframe;
      }

      // ==========================================================================
      // APPLY SETTINGS
      // ==========================================================================

      function applyStyles(element, settings) {
        if (!element) return;

        element.style.objectFit = settings.objectFit || 'contain';
        element.style.objectPosition = settings.objectPosition || 'center';
        element.style.opacity = (settings.opacity ?? 100) / 100;
        element.style.filter = buildFilterString(settings);
        element.style.borderRadius = `${settings.borderRadius || 0}px`;
      }

      function applyContainerStyles(settings) {
        container.style.backgroundColor = settings.backgroundColor || 'transparent';
        container.style.borderRadius = `${settings.borderRadius || 0}px`;
      }

      function applyVideoSettings(video, settings) {
        if (!video || video.tagName !== 'VIDEO') return;

        video.loop = settings.loop;
        video.muted = settings.muted;
        video.controls = settings.showControls;

        if (video.playbackRate !== settings.playbackRate) {
          video.playbackRate = settings.playbackRate;
        }

        // Handle autoplay changes
        if (settings.autoplay && video.paused && !isPaused) {
          video.play().catch(e => console.log('[MediaViewer] Autoplay blocked:', e));
        } else if (!settings.autoplay && !video.paused) {
          video.pause();
        }
      }

      // ==========================================================================
      // MEDIA LOADING
      // ==========================================================================

      function getMediaSource(settings) {
        // Use sourceType to determine which field to use
        switch (settings.sourceType) {
          case 'file':
            return { type: 'direct', url: settings.mediaFile || null };
          case 'fileVideo':
            return { type: 'direct', url: settings.mediaVideo || null };
          case 'embed':
            return { type: 'embed', url: settings.embedUrl || null };
          case 'url':
          default:
            return { type: 'direct', url: settings.mediaUrl || null };
        }
      }

      function loadMedia(settings) {
        const source = getMediaSource(settings);

        if (!source.url) {
          const messages = {
            'file': 'No image uploaded',
            'fileVideo': 'No video uploaded',
            'embed': 'No video URL provided',
            'url': 'No URL configured'
          };
          showFallback(messages[settings.sourceType] || 'No URL configured');
          return;
        }

        showLoading();

        // Clear previous media
        if (currentMediaEl) {
          if (currentMediaEl.tagName === 'VIDEO') {
            currentMediaEl.pause();
            currentMediaEl.src = '';
          }
          currentMediaEl.remove();
          currentMediaEl = null;
        }

        // Handle embed sources (YouTube, Vimeo, Twitch, Dailymotion)
        if (source.type === 'embed') {
          const embedData = parseEmbedUrl(source.url, settings);
          if (!embedData) {
            showFallback('Unsupported video platform. Try YouTube, Vimeo, Twitch, or Dailymotion.');
            return;
          }
          console.log('[MediaViewer] Loading embed:', embedData.platform, embedData.videoId);
          currentMediaEl = createEmbedElement(embedData, settings);
          applyStyles(currentMediaEl, settings);
          applyContainerStyles(settings);
          mediaWrapper.appendChild(currentMediaEl);
          return;
        }

        // Handle direct media (images, videos)
        const mediaType = getMediaType(source.url);
        console.log('[MediaViewer] Loading media:', source.url, 'type:', mediaType);

        if (mediaType === 'video') {
          currentMediaEl = createVideoElement(source.url, settings);
        } else if (mediaType === 'image') {
          currentMediaEl = createImageElement(source.url, settings);
        } else if (mediaType === 'unknown') {
          // Try as image first, then video
          currentMediaEl = createImageElement(source.url, settings);
          currentMediaEl.onerror = () => {
            console.log('[MediaViewer] Image failed, trying as video');
            currentMediaEl.remove();
            currentMediaEl = createVideoElement(source.url, settings);
            applyStyles(currentMediaEl, settings);
            mediaWrapper.appendChild(currentMediaEl);
          };
        } else {
          showFallback('Unsupported media type');
          return;
        }

        applyStyles(currentMediaEl, settings);
        applyContainerStyles(settings);
        mediaWrapper.appendChild(currentMediaEl);
      }

      function setupRefreshTimer(intervalMinutes) {
        if (refreshTimer) {
          clearInterval(refreshTimer);
          refreshTimer = null;
        }

        if (intervalMinutes > 0) {
          const intervalMs = intervalMinutes * 60 * 1000;
          refreshTimer = setInterval(() => {
            console.log('[MediaViewer] Auto-refreshing media');
            loadMedia(api.config);
          }, intervalMs);
        }
      }

      // ==========================================================================
      // EVENT HANDLERS
      // ==========================================================================

      api.onSettingsChange((settings, changedKeys) => {
        console.log('[MediaViewer] Settings changed:', changedKeys);

        // Check if media source changed (URL, file, video file, embed URL, or source type selector)
        const mediaChanged = changedKeys.includes('mediaUrl') ||
                            changedKeys.includes('mediaFile') ||
                            changedKeys.includes('mediaVideo') ||
                            changedKeys.includes('embedUrl') ||
                            changedKeys.includes('sourceType');

        if (mediaChanged) {
          loadMedia(settings);
        } else {
          // Apply style changes without reloading
          applyStyles(currentMediaEl, settings);
          applyContainerStyles(settings);

          // Video-specific settings
          if (currentMediaEl?.tagName === 'VIDEO') {
            applyVideoSettings(currentMediaEl, settings);
          }
        }

        // Handle refresh interval change
        if (changedKeys.includes('refreshInterval')) {
          setupRefreshTimer(settings.refreshInterval);
        }

        // Update fallback text
        if (changedKeys.includes('fallbackText') && !fallbackEl.classList.contains('hidden')) {
          fallbackText.textContent = settings.fallbackText;
        }
      });

      api.onEvent('viewport:resize', ({ width, height }) => {
        console.log(`[MediaViewer] Viewport resized: ${width}x${height}`);
        // Media elements auto-resize via CSS, no action needed
      });

      api.onEvent('theme:change', ({ theme }) => {
        console.log(`[MediaViewer] Theme changed: ${theme}`);
        document.body.dataset.theme = theme;
      });

      api.onEvent('visibility:change', ({ visible }) => {
        console.log(`[MediaViewer] Visibility changed: ${visible}`);
        if (currentMediaEl?.tagName === 'VIDEO') {
          if (!visible && !currentMediaEl.paused) {
            currentMediaEl.pause();
          } else if (visible && api.config.autoplay && !isPaused) {
            currentMediaEl.play().catch(() => {});
          }
        }
      });

      api.onMount(() => {
        console.log('[MediaViewer] Mounted');
      });

      api.onUnmount(() => {
        console.log('[MediaViewer] Unmounting - cleaning up');
        if (refreshTimer) {
          clearInterval(refreshTimer);
        }
        if (currentMediaEl?.tagName === 'VIDEO') {
          currentMediaEl.pause();
        }
      });

      api.onPause(() => {
        console.log('[MediaViewer] Paused');
        isPaused = true;
        if (currentMediaEl?.tagName === 'VIDEO' && !currentMediaEl.paused) {
          currentMediaEl.pause();
        }
      });

      api.onResume(() => {
        console.log('[MediaViewer] Resumed');
        isPaused = false;
        if (currentMediaEl?.tagName === 'VIDEO' && api.config.autoplay) {
          currentMediaEl.play().catch(() => {});
        }
      });

      // ==========================================================================
      // INITIALIZATION
      // ==========================================================================

      function init() {
        console.log('[MediaViewer] Initializing...');

        // Apply initial settings
        loadMedia(api.config);
        setupRefreshTimer(api.config.refreshInterval);

        // Signal ready
        api.ready({
          capabilities: ['hot-reload'],
          subscribedEvents: ['viewport:resize', 'theme:change', 'visibility:change']
        });

        console.log('[MediaViewer] Ready! SDK v' + api.version);
      }

      init();

    })();
  </script>
</body>
</html>
